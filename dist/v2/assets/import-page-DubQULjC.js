import{j as e}from"./shiki-CtY5KH0E.js";import{a as u}from"./react-BSMx3yqy.js";import{u as ke,S as ne,a as R,F as N,b as T,c as Te,w as $,B as Pe,D as Fe,d as ze,e as Ae,f as Le,g as De,s as Me,h as _e,A as G,i as U,C as Ue,j as p,k as A,R as L,I as x,l as le,m as ie,n as oe,P as Ve,o as b,p as ce,L as V,r as B,T as E,q as de,t as me,v as z,x as xe,y as Be,z as H,E as W,G as ue,H as Oe,J as $e,K as Ge,M as He,N as We,O as pe,Q as Qe,U as Ye,V as ge,W as he,X as fe,Y as Ke,Z as Je,_ as M,$ as qe,a0 as je,a1 as Xe,a2 as Ze,a3 as Q,a4 as es,a5 as ss,a6 as ye,a7 as ts,a8 as rs,a9 as as,aa as ns,ab as ls,ac as is,ad as os,ae as cs,af as ds,ag as ms,ah as xs}from"./index-rCMhFuXx.js";import"./reactJsonView-KCeSiE7A.js";import"./echarts-lseLLy92.js";import"./monaco-CdFZwoqU.js";import"./prettier-BE4rBlSX.js";const se=s=>{const{field:t}=ke({name:s.name,control:s.control});return e.jsx(ne,{...s,...t,onValueChange:t.onChange,ref:t.ref})},P=new Map([[R.INFO,"Info"],[R.ERROR,"Error"],[R.WARNING,"Warning"],[R.DEBUG,"Debug"]]),O=new Map([[N.AddTags,"Add Tags"],[N.Celery,"Celery"],[N.ImportRuns,"Import"],[N.MetaCaterigozation,"Meta Categorization"]]),us=[{value:"all",displayValue:"All"},...Array.from(P.entries()).map(([s,t])=>({value:s,displayValue:t}))],ps=[{value:"all",displayValue:"All"},...Array.from(O.entries()).map(([s,t])=>({value:s,displayValue:t}))],be=s=>new Map([[R.DEBUG,"bg-badge-6"],[R.ERROR,"bg-badge-5 text-text-unexpected"],[R.WARNING,"bg-bg-warning text-white"]]).get(s)??"bg-badge-0",ve=u.createContext(null);function Y(){const s=u.useContext(ve);if(!s)throw new Error("useImportLog must be used within <ImportLogContextProvider />");return s}function gs({children:s}){const[t,a]=T("taskId",Te),[n=!1,r]=T("poll",$(Pe,!1));function i(d,m){return()=>{a(l=>l?null:d),typeof m<"u"&&r(m)}}function c(){a(null),r(null)}return e.jsxs(ve.Provider,{value:{toggle:i},children:[e.jsx(hs,{taskId:t,enablePolling:n,close:c}),s]})}function hs(s){const{taskId:t,enablePolling:a,close:n}=s;return e.jsx(Fe,{open:!!t,onOpenChange:r=>{r||n()},children:e.jsx(ze,{children:e.jsx(Ae,{className:"w-[80vw] flex flex-col",onInteractOutside:n,onEscapeKeyDown:n,children:e.jsx(fs,{taskId:t,enablePolling:a})})})})}function te(s){const t=[/run id is (\d+)/i,/mi run id:\s*(\d+)/i];for(const a of s)for(const n of t){const r=a.message.match(n);if(r)return parseInt(r[1],10)}return null}const Ne="bg-[#24292f]",fs=s=>{const{taskId:t}=s,[a,n]=u.useState(!0),[r,i]=u.useState(s.enablePolling),[c,d]=Le("import-log-text-wrap",!0),{data:m,isLoading:l,isFetching:g,error:h}=De(t||Me,{pollingInterval:r?5e3:0}),f=u.useRef(null),[,S]=_e({onSuccess:()=>G.success("Copied to clipboard")}),v=u.useCallback(()=>{const o=f.current;if(!o)return;const j=Math.abs(o.scrollHeight-o.scrollTop-o.clientHeight)<10;n(j)},[]);if(u.useEffect(()=>{const o=f.current;if(o)return o.addEventListener("scroll",v),()=>o.removeEventListener("scroll",v)},[v]),u.useEffect(()=>{const o=f.current;if(!o||!m)return;if(te(m)){i(!1);return}!r||!a||setTimeout(()=>o.scrollTo({top:o.scrollHeight,behavior:"smooth"}),0)},[m,r,a,g]),h)return e.jsx(js,{error:h});if(l)return e.jsx(U,{className:"w-full h-full"});if(!m)return e.jsx("div",{className:"grid place-items-center h-full",children:"Not Log Found"});const I=te(m),D=r&&!a;return e.jsxs(e.Fragment,{children:[e.jsx(Ue,{label:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-text-primary text-[0.75rem] font-semibold leading-[0.875rem]",children:["Import: ",t]}),e.jsx(ys,{show:!!r})]}),className:"px-4 py-2 flex gap-4 items-center justify-between",children:e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(bs,{runId:I}),e.jsx(p,{asChild:!0,variant:"secondary",size:"xss",children:e.jsxs("a",{href:`${A.oldBaseUrl}/flower/task/${t}`,target:"_blank",rel:"noreferrer",children:[e.jsx(L,{className:"mr-1.5"}),e.jsx("span",{children:"Task"})]})}),e.jsxs(p,{variant:"secondary",size:"xss",onClick:async()=>{m&&await S(m.map(o=>o.message.trim()).join(`
`))},children:[e.jsx(x,{name:"PaperStack",size:20,className:"mr-1.5"}),e.jsx("span",{children:"Copy Log"})]}),e.jsxs(p,{variant:c?"primary":"secondary",onClick:()=>d(o=>!o),size:"xss",children:[e.jsx(x,{name:"TextWrap",size:18,className:"mr-1.5"}),e.jsx("span",{children:"Line Wrap"})]}),e.jsx(le,{className:"p-0.5 rounded-md hover:bg-primary-wash hover:text-primary text-text-menu",children:e.jsx(x,{name:"CrossSimple",size:20})})]})}),e.jsxs("div",{className:"relative flex-grow overflow-hidden",children:[e.jsx(ie,{children:D?e.jsxs(oe.div,{className:"flex items-center gap-1 px-2 py-0.5 text-xs text-white rounded-full bg-primary absolute bottom-12 left-1/2 -translate-x-1/2",initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},children:[e.jsx(Ve,{className:"size-4"}),e.jsx("span",{children:"Scrolling Paused"})]}):null}),e.jsx("div",{className:b("flex-grow overflow-hidden h-full",Ne),ref:f,children:e.jsx(ws,{logs:m,textWrap:c})})]})]})};function js({error:s}){const{status:t,title:a,description:n}=ce(s);return e.jsx("div",{className:"grid place-items-center h-full",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx(x,{name:"TriangleExclamationMark",size:24,className:"text-text-unexpected"}),e.jsxs("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:[t," ",a]}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:n})]})})}function ys(s){return e.jsx(ie,{children:s.show?e.jsx(oe.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:e.jsx(E,{content:"Run import is in progress",children:e.jsx(x,{name:"InformationCircleProgress",size:24,className:"text-primary p-0.5 animate-spin"})})}):null})}function bs({runId:s}){if(s)return e.jsxs(e.Fragment,{children:[e.jsx(p,{asChild:!0,variant:"secondary",size:"xss",children:e.jsxs(V,{to:B.log({runId:s}),target:"_blank",children:[e.jsx(x,{name:"BoxArrowRight",className:"mr-1.5"}),"Log"]})}),e.jsx(p,{asChild:!0,variant:"secondary",size:"xss",children:e.jsxs(V,{to:B.run({runId:s}),target:"_blank",children:[e.jsx(x,{name:"BoxArrowRight",className:"mr-1.5"}),"Run"]})})]})}const k=xe();function vs({textWrap:s}){return[k.display({id:"line-number",header:"#",cell:({row:t})=>t.index+1,meta:{className:"text-[#8c959f] hover:text-primary hover:underline"}}),k.accessor("asctime",{header:"Time",cell:t=>t.getValue()}),k.accessor("levelname",{header:"Level",cell:t=>t.getValue()}),k.accessor("module",{header:"Module",cell:t=>t.getValue()}),k.accessor("message",{header:"Message",cell:t=>t.getValue(),meta:{className:s?"whitespace-pre-wrap break-words":"whitespace-nowrap"}})]}const Ns=s=>{const t="hover:bg-gray-600/20";return s==="CRITICAL"?`${t} bg-red-950/30 text-red-100 hover:text-red-50 font-semibold`:s==="ERROR"?`${t} bg-red-900/20 text-red-200 hover:text-red-100`:s==="WARN"||s==="WARNING"?`${t} bg-yellow-900/20 text-yellow-200 hover:text-yellow-100`:s==="DEBUG"?`${t} text-gray-400 hover:text-gray-300`:`${t} text-gray-200 hover:text-gray-50`},ws=s=>{const{textWrap:t=!0,logs:a}=s,n=de({data:a,columns:vs({textWrap:t}),getCoreRowModel:me()});return e.jsx("div",{className:"font-mono text-xs leading-5 pb-12 px-2 flex-1 h-full overflow-auto",children:e.jsxs("table",{className:"w-full border-collapse",children:[n.getHeaderGroups().map(r=>e.jsx("thead",{children:e.jsx("tr",{children:r.headers.map(i=>e.jsx("th",{className:b("px-1 py-2 text-left text-gray-400 font-semibold sticky top-0",Ne),children:z(i.column.columnDef.header,i.getContext())},i.id))})},r.id)),e.jsx("tbody",{children:n.getRowModel().rows.map(r=>e.jsx("tr",{className:Ns(r.original.levelname),children:r.getVisibleCells().map(i=>{const c=i.column.columnDef.meta?.className??"";return e.jsx("td",{className:b("px-1 whitespace-nowrap",c),children:z(i.column.columnDef.cell,i.getContext())},i.id)})},r.id))})]})})};function we(s){return{SUCCESS:"bg-bg-ok",FAILURE:"bg-bg-error",STARTED:"bg-bg-running",RECEIVED:"bg-gray-400"}[s]??""}function Ce(s){return{SUCCESS:a=>e.jsx(x,{name:"InformationCircleCheckmark",...a}),FAILURE:a=>e.jsx(x,{name:"InformationCircleCrossMark",...a}),STARTED:a=>e.jsx(x,{name:"Play",...a}),RECEIVED:a=>e.jsx(x,{name:"Download",...a})}[s]}const C=xe();function Cs(s){const{runId:t,taskId:a,status:n}=s,{toggle:r}=Y();return a?e.jsxs("div",{className:"flex flex-col justify-center gap-1 w-fit",children:[t&&e.jsx(V,{to:B.run({runId:t}),children:e.jsxs(p,{variant:"secondary",size:"xss",className:"justify-start",children:[e.jsx(x,{name:"BoxArrowRight",size:20,className:"mr-1.5"}),e.jsx("span",{children:"Run"})]})}),e.jsxs(p,{variant:"secondary",size:"xss",className:"justify-start",onClick:r(a,n==="STARTED"),children:[e.jsx(x,{name:"Paper",size:20,className:"mr-1.5"}),e.jsx("span",{children:"Log"})]}),e.jsx(p,{variant:"secondary",size:"xss",className:"justify-start",asChild:!0,children:e.jsxs("a",{href:`${A.oldBaseUrl}/flower/task/${a}`,target:"_blank",rel:"noreferrer",children:[e.jsx(L,{className:"mr-1.5 size-4"}),e.jsx("span",{children:"Task"})]})})]}):e.jsx("div",{className:"flex items-center gap-2 px-2",children:e.jsx(E,{content:"No celery task available",children:e.jsx(x,{name:"TriangleExclamationMark",size:20,className:"text-text-unexpected"})})})}const re=[C.accessor("status",{id:"EVENT_TYPE",header:"",cell:s=>{const t=s.getValue(),a=Ce(t);return e.jsx(E,{content:t,side:"right",align:"start",children:e.jsx("div",{className:b("h-[calc(100%+2px)] w-[24px] flex flex-col items-center",s.row.getIsExpanded()?"rounded-tl":"rounded-l",we(t)),children:e.jsx(a,{className:"mt-3.5 text-white",size:18})})})},meta:{className:"p-0",width:"24px"}}),C.accessor("celery_task",{id:"ACTIONS",header:()=>e.jsx("span",{className:"pl-2",children:"Actions"}),cell:s=>e.jsx(Cs,{taskId:s.getValue(),runId:s.row.original.run_id,status:s.row.original.status}),meta:{width:"min-content"}}),C.accessor("timestamp",{header:"Date",cell:s=>{const t=s.getValue();return t?Be(t):null},meta:{width:"0.1fr"}}),C.accessor("facility",{header:()=>e.jsx("span",{className:"pl-2",children:"Facility"}),cell:s=>{const t=s.getValue();return e.jsx(Re,{facility:t})},meta:{width:"0.1fr"}}),C.accessor("severity",{header:()=>e.jsx("span",{className:"pl-2",children:"Severity"}),cell:s=>{const t=s.getValue();return t?e.jsx(H,{className:be(t),children:P.has(t)?P.get(t)?.toUpperCase():t.toUpperCase()}):null},meta:{width:"0.1fr"}}),C.accessor("error_msg",{header:"Message",cell:s=>{const t=s.getValue();return t?e.jsx("span",{className:"whitespace-pre-wrap font-mono",children:t}):null},meta:{width:"1fr"}}),C.accessor("uri",{id:"URI",header:"URL",cell:s=>{const t=s.getValue();return W.string().url().safeParse(t).success?e.jsx("a",{href:t,className:"hover:underline whitespace-pre-wrap text-primary",target:"_blank",rel:"noreferrer",children:t}):null},meta:{width:"1fr"}}),C.display({id:"expand",cell:({row:s})=>{const t=s.original.severity===R.ERROR&&s.original.facility===N.ImportRuns,[a]=ue();return e.jsxs("div",{className:"flex items-center gap-2 w-full justify-end",children:[t?e.jsxs(p,{variant:"secondary",size:"xss",onClick:async()=>{const n=a([{force:!0,url:s.original.uri,range:null}]);G.promise(n,{success:"Triggered re-import successfully",error:"Failed to trigger re-import"}),await n},children:[e.jsx(x,{name:"Refresh",size:20,className:"mr-1.5"}),e.jsx("span",{children:"Try Again"})]}):null,e.jsx(E,{content:"Expand/Collapse",children:e.jsx("button",{className:b("grid place-items-center p-1 rounded-md hover:bg-primary-wash text-primary",s.getIsExpanded()&&"bg-primary text-white hover:text-white hover:bg-primary",!s.getCanExpand()&&"hidden"),onClick:()=>s.toggleExpanded(),children:e.jsx(x,{name:"ArrowShortTop",className:b("size-5","rotate-90",s.getIsExpanded()&&"rotate-180")})})})]})},meta:{width:"min-content"}})];function Rs(s){const{data:t,pagination:a,setPagination:n,rowCount:r,expanded:i,setExpanded:c}=s,d=de({state:{pagination:a,expanded:i},data:t,columns:re,getCoreRowModel:me(),getFilteredRowModel:He(),getPaginationRowModel:Ge(),getGroupedRowModel:$e(),getExpandedRowModel:Oe(),onPaginationChange:n,onExpandedChange:c,getRowId:l=>l.event_id.toString(),getRowCanExpand:l=>l?.original?.children?.length>1,rowCount:r,manualPagination:!0}),m=re.map(l=>l.meta?.width||"minmax(0, 1fr)").join(" ");return e.jsxs("div",{children:[e.jsx("div",{className:"w-full overflow-hidden",children:e.jsxs("div",{className:"grid",style:{gridTemplateColumns:m},children:[d.getHeaderGroups().map(l=>e.jsx(u.Fragment,{children:l.headers.map(g=>{const h=g.column.columnDef.meta?.className;return e.jsx("div",{className:b("tracking-wider sticky top-0 mb-1 px-1 py-2 text-left text-[0.6875rem] font-semibold leading-[0.875rem] bg-white",h),children:g.isPlaceholder?null:z(g.column.columnDef.header,g.getContext())},g.id)})},l.id)),d.getRowModel().rows.map(l=>e.jsx(Is,{row:l},l.id))]})}),e.jsx("div",{className:"flex items-center justify-center mt-4",children:e.jsx(We,{totalCount:r,pageSize:d.getState().pagination.pageSize,onPageChange:l=>d.setPageIndex(l-1),onPageSizeChange:d.setPageSize,currentPage:d.getState().pagination.pageIndex+1})})]})}function Is({row:s}){const[t,a]=u.useState(!1),{toggle:n}=Y();return e.jsxs(u.Fragment,{children:[s.getVisibleCells().map((r,i,c)=>{const d=r.column.columnDef.meta?.className;return e.jsx("div",{className:b("px-1 py-2 bg-white text-text-primary whitespace-nowrap text-[0.75rem] leading-[1.125rem] font-medium","flex items-center transition-colors","border-transparent",i!==0&&"border-y",i===c.length-1&&"border-r rounded-r",!s.getIsExpanded()&&"mb-1",s.getCanExpand()&&"cursor-pointer",t&&"border-primary",d),onMouseEnter:()=>a(!0),onMouseLeave:()=>a(!1),onClick:m=>{m.target.closest("a, button")||!s.getCanExpand()||s.toggleExpanded()},children:z(r.column.columnDef.cell,r.getContext())},r.id)}),s.getIsExpanded()&&e.jsx("div",{className:"col-span-full",children:Ts({row:s,toggle:n})})]},s.id)}const Es=()=>e.jsxs("div",{className:"flex flex-col gap-1 mt-1",children:[e.jsx(U,{className:"h-10"}),Array(25).fill(0).map((s,t)=>e.jsx(U,{className:"rounded h-[52.5px]"},t))]}),Ss=s=>{const{description:t,status:a,title:n}=ce(s.error);return e.jsx("div",{className:"flex items-center justify-center flex-grow h-screen",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(x,{name:"TriangleExclamationMark",size:48,className:"text-text-unexpected"}),e.jsxs("div",{className:"flex flex-col gap-0.5",children:[e.jsxs("h2",{className:"text-2xl font-bold",children:[a," ",n]}),e.jsx("p",{className:"text-lg",children:t})]})]})})},ks=()=>e.jsx("div",{className:"grid place-items-center h-[calc(100vh-176px)]",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx(x,{name:"TriangleExclamationMark",size:48,className:"text-text-unexpected"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No results found"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"No results found, please try another search."})]})}),ae="__no-task__";function Ts(s){const{row:{original:{children:t}},toggle:a}=s,n=t.reduce((r,i)=>{const c=i.celery_task??ae;return r[c]||(r[c]=[]),r[c].push(i),r},{});return e.jsx("div",{className:"bg-white px-4 py-8 border-t border-border-primary mb-1",children:e.jsxs("div",{className:"relative flex flex-col gap-8",children:[e.jsx("div",{className:"absolute left-10 top-12 bottom-16 z-10 w-0.5 bg-border-primary"}),Object.entries(n).map(([r,i],c,d)=>{const m=r===ae;return e.jsxs("div",{className:"border relative rounded-md border-border-primary p-4 hover:border-primary transition-colors",children:[c!==d.length-1&&e.jsx("div",{className:"absolute left-7 top-[95%] size-6 bg-white z-0"}),c!==0&&e.jsx("div",{className:"absolute left-7 -top-[5%] size-6 bg-white z-0"}),e.jsxs("div",{className:"flex items-center absolute -top-[15px] px-2 left-[80px] bg-white",children:[e.jsx("span",{className:"text-sm text-text-primary font-semibold",children:"Task:"}),m?e.jsxs(e.Fragment,{children:[e.jsx(H,{variant:"warning",className:"ml-2",children:"No celery task available"}),e.jsx("span",{className:"text-xs text-text-secondary ml-2",children:"These events cannot be opened in Flower or have their logs viewed"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("code",{className:"text-sm text-gray-800 whitespace-pre-wrap",children:[" ",r]}),e.jsx("span",{className:"px-2",children:"•"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(p,{variant:"secondary",size:"xss",onClick:a(r),children:[e.jsx(x,{name:"Paper",size:20,className:"mr-1.5"}),e.jsx("span",{children:"Log"})]}),e.jsx(p,{variant:"secondary",size:"xss",className:"justify-start",asChild:!0,children:e.jsxs("a",{href:`${A.oldBaseUrl}/flower/task/${r}`,target:"_blank",rel:"noreferrer",children:[e.jsx(L,{className:"mr-1.5 size-4"}),e.jsx("span",{children:"Task"})]})})]})]})]}),e.jsx("div",{className:"relative pl-8",children:e.jsx("div",{className:"space-y-4",children:i.map((l,g)=>{const h=Ce(l.status),f=we(l.status);return e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:`absolute -left-[24px] top-[11px] flex size-8 items-center justify-center rounded-full ${f} text-white z-10`,children:e.jsx(h,{className:"size-6"})}),e.jsxs("div",{className:"space-y-3 rounded-lg ml-4 border border-border-primary bg-gray-50/70 p-4",children:[e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ie,{status:l.status}),e.jsx(Re,{facility:l.facility}),e.jsx(zs,{severity:l.severity})]}),e.jsx("div",{children:e.jsxs("div",{className:"flex items-center gap-2 text-xs leading-5 text-text-primary flex-wrap",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(x,{name:"Clock",className:"size-4"}),e.jsx("span",{children:pe(Ye(l.timestamp),Qe)})]}),l.runtime&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsx("div",{className:"flex items-center gap-1",children:e.jsxs("span",{children:["Runtime: ",Fs(l.runtime)]})})]})]})})]}),l.error_msg&&e.jsx("p",{className:"font-medium text-xs bg-primary-wash p-4 rounded-md",children:l.error_msg})]})]},l.event_id)})})})]},r)})]})})}const Ps=ge({base:["inline-flex","items-center","w-fit","py-0.5","px-2","rounded","border","border-transparent","leading-[1.125rem]","text-[0.75rem]","font-medium","transition-colors"],variants:{variant:{[N.ImportRuns]:["bg-blue-100","text-blue-800"],[N.MetaCaterigozation]:["bg-purple-100","text-purple-800"],[N.AddTags]:["bg-green-100","text-green-800"],[N.Celery]:["bg-amber-100","text-amber-800"]}}});function Fs(s){const t=Math.floor(s/3600),a=Math.floor(s%3600/60),n=(s%60).toFixed(2),r=[];return t>0&&r.push(`${t}h`),a>0&&r.push(`${a}m`),r.push(`${n}s`),r.join(" ")}function Re(s){if(!s.facility)return null;const t=O.has(s.facility)?O.get(s.facility):s.facility;return e.jsx("span",{className:Ps({variant:s.facility}),children:t?.toUpperCase()})}function zs(s){const{severity:t}=s;return e.jsx(H,{className:be(t),children:P.has(t)?P.get(t)?.toUpperCase():t.toUpperCase()})}const As=ge({base:["inline-flex","w-fit","px-2 py-0.5","text-xs","leading-5","rounded","items-center"],variants:{variant:{SUCCESS:["bg-bg-ok","text-white"],FAILURE:["bg-badge-12","text-white"],STARTED:["bg-primary","text-white"],UNKNOWN:["bg-badge-0","text-text-primary"]}},defaultVariants:{variant:"UNKNOWN"}});function Ie({status:s,className:t,...a}){return e.jsx("div",{className:b(As({variant:s}),t),...a,children:s})}const Ls=s=>{const{register:t,control:a,handleSubmit:n,formState:{errors:r}}=he({defaultValues:s.defaultValues,resolver:fe(Ke)}),i=Je(),c=()=>n(d=>{const m=d.severity==="all"?void 0:d.severity,l=d.facility==="all"?void 0:d.facility;return i(je.util.invalidateTags([Xe.importEvents])),s.onFiltersChange?.({severity:m,facility:l,date:d.date,msg:d.msg?.trim(),task_id:d.task_id?.trim(),url:d.url?.trim()})});return e.jsxs("form",{onSubmit:c(),className:"flex flex-wrap items-center gap-4",children:[e.jsx("div",{children:e.jsx(se,{name:"severity",placeholder:"Select severity",control:a,label:"Severity",options:us})}),e.jsx("div",{children:e.jsx(se,{name:"facility",placeholder:"Select facility",control:a,label:"Facility",options:ps})}),e.jsx("div",{children:e.jsx(M,{label:"Message",placeholder:"Message...",...t("msg"),error:r.msg?.message})}),e.jsx("div",{children:e.jsx(M,{label:"URL",placeholder:"https://example.com/logs/2022/11/14/fili-mcx5-14/",...t("url"),error:r.url?.message})}),e.jsx("div",{children:e.jsx(M,{label:"Task ID",placeholder:"c8a4d0b8-b3d4-4b38-9dbd-352fcd8beae0",...t("task_id"),error:r.task_id?.message})}),e.jsx("div",{children:e.jsx(qe,{label:"Date",name:"date",control:a})}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs(p,{size:"md",rounded:"lg",className:"justify-center",type:"submit",variant:"primary",children:[e.jsx(x,{name:"Refresh",size:24,className:"mr-1.5"}),e.jsx("span",{children:"Submit"})]}),e.jsx(E,{content:"Reset Filters",children:e.jsx(p,{type:"button",variant:"outline","aria-label":"Reset Form",className:"grid size-10 place-items-center text-text-menu hover:text-primary",onClick:s.onResetClick,children:e.jsx(x,{name:"Bin",size:24})})})]})]})},Ds=$(Q,{date:void 0,facility:"importruns",msg:void 0,severity:void 0,task_id:void 0,url:void 0}),Ms=$(Q,{pageIndex:0,pageSize:25});function _s(){const[s,t]=T("pagination",Ms);return{pagination:s,setPagination:t}}function Us(){const[s,t]=T("expanded",Q);return{expanded:s,setExpanded:t}}const Vs=()=>{const[s,t]=T("filters",Ds),a=r=>{t(r,"replaceIn")},n=()=>{t({date:void 0,facility:"importruns",msg:void 0,severity:void 0,task_id:void 0,url:void 0},"replace")};return{query:{...s,date:s?.date?new Date(s.date):void 0},setQuery:a,onResetClick:n}},Bs=s=>{const{query:t,setQuery:a,onResetClick:n}=Vs(),{pagination:r,setPagination:i}=_s(),{expanded:c,setExpanded:d}=Us(),{data:m,isLoading:l,error:g}=Ze({...t,page:r.pageIndex+1,page_size:r.pageSize},{pollingInterval:r.pageIndex===0?5e3:0,refetchOnFocus:!0,refetchOnMountOrArgChange:!0}),[h,f]=u.useState(!1),S=u.useRef(null);return u.useEffect(()=>{const v=S.current;if(!v)return;const I=()=>{f(v.scrollTop>0)};return v.addEventListener("scroll",I),()=>v.removeEventListener("scroll",I)},[]),e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"px-6 py-4 bg-white rounded-t-xl",children:e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-4",children:[e.jsx(Ls,{onFiltersChange:a,defaultValues:t,onResetClick:n},JSON.stringify(t)),s.children]})}),e.jsx("div",{className:"flex flex-col overflow-auto flex-grow",ref:S,children:l?e.jsx(Es,{}):g?e.jsx(Ss,{error:g}):m&&m.results.length?e.jsx(Rs,{data:m.results,pagination:r,setPagination:i,expanded:c,setExpanded:d,rowCount:m.pagination.count,isScrolled:h}):e.jsx(ks,{})})]})},Os=s=>s.split(new RegExp("[\\n\\s]")),F="default",$s={runs:[{url:"",force:null,range:null,project:null},{url:"",force:null,range:null,project:null},{url:"",force:null,range:null,project:null},{url:"",force:null,range:null,project:null}]},Gs=u.forwardRef(({onImportRunsSubmit:s,projects:t},a)=>{const n=he({defaultValues:$s,resolver:fe(es)});u.useImperativeHandle(a,()=>({form:n}),[n]);const{fields:r,append:i,remove:c}=ss({name:"runs",control:n.control}),d=u.useCallback(o=>{if(o.target.tagName==="INPUT")return;const w=o.clipboardData?.getData("text");if(!w)return;const K=Os(w).filter(Boolean);if(!K.every(y=>W.string().url().safeParse(y).success))return G.error("Pasted URLs are incorrect!");o.preventDefault();const Ee=K.map(y=>new URL(y)).map(y=>{const q=[y.protocol,"//",y.host,y.pathname].join(""),X=y.searchParams.get("force")==="true",Z=y.searchParams.get("from"),ee=y.searchParams.get("to");if(!Z||!ee)return{url:q,force:X,range:null};const Se={startDate:new Date(Z),endDate:new Date(ee)};return{url:q,force:X,range:Se}});c(r.map((y,J)=>J)),i(Ee)},[i,r,c]);u.useEffect(()=>(document.addEventListener("paste",d),()=>document.removeEventListener("paste",d)),[d]);const m=["URL","RANGE",""],l=n.formState.errors.root?.message,g=o=>{r.forEach((j,w)=>{n.setValue(`runs.${w}.force`,o)})},h=o=>{r.forEach((j,w)=>{if(o===F){n.setValue(`runs.${w}.project`,null);return}n.setValue(`runs.${w}.project`,parseInt(o))})},f=r.length>0&&r.every((o,j)=>n.watch(`runs.${j}.force`)===!0),S=[{value:F,displayValue:"No Project (Default)"},...t.map(o=>({value:o.id.toString(),displayValue:o.name}))],v=n.watch("runs"),I=new Set(v.map(o=>o.project?.toString()??F)),D=I.size===1?[...I][0]:F;return e.jsxs(e.Fragment,{children:[e.jsx(ye,{className:"text-lg font-semibold leading-none tracking-tight",children:"Import Runs"}),l?e.jsx(ts,{title:"Error",description:l}):null,e.jsxs("form",{className:"flex flex-col gap-4 mt-2",onSubmit:n.handleSubmit(o=>s?.({...o,runs:o.runs.filter(j=>j.url)})),children:[e.jsx(ne,{label:"Project",options:S,value:D,onValueChange:h}),e.jsxs("p",{className:"text-gray-500 text-sm leading-relaxed font-normal space-y-1",children:[e.jsxs("span",{children:["Run must be linked to a project. If it isn’t, the import will fail."," ",e.jsx("br",{}),"You can link it here in the import form or in the run’s",e.jsx("code",{className:"mx-1 bg-gray-100 px-1 py-0.5 rounded text-gray-700",children:"meta_data.json"}),".",e.jsx("br",{})]}),e.jsx("span",{className:"font-medium text-gray-600",children:"Precedence order:"}),e.jsxs("ol",{className:"list-decimal list-inside mt-1 space-y-0.5",children:[e.jsx("li",{children:"Project specified in the import form"}),e.jsxs("li",{children:["Project specified in"," ",e.jsx("code",{className:"bg-gray-100 px-1 py-0.5 rounded text-gray-700",children:"meta_data.json"})]})]})]}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("div",{className:"grid grid-cols-[1fr,min-content,min-content] gap-y-2 gap-x-2",children:[m.map(o=>e.jsx(Hs,{children:o},o)),r.map((o,j)=>e.jsx(Ws,{idx:j,field:o,formApi:n,remove:c},o.id))]}),e.jsxs(p,{type:"button",rounded:"lg",size:"md",variant:"outline",onClick:()=>i({url:"",force:!1,range:null,project:null}),children:[e.jsx(x,{name:"AddSymbol",size:24,className:"mr-1.5 text-primary"}),e.jsx("span",{children:"Add"})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(rs,{id:"force-import",checked:f,onCheckedChange:g,"aria-label":"Force import for all runs"}),e.jsx("label",{htmlFor:"force-import",className:"text-sm font-medium",children:"Force Import"})]}),e.jsx("div",{children:e.jsxs(p,{type:"submit",rounded:"lg",size:"md",variant:"primary",className:"w-full",children:[n.formState.isSubmitting?e.jsx(x,{name:"ProgressIndicator",className:"pr-2"}):null,n.formState.isSubmitting?"Importing...":"Start Import"]})})]})]})}),Hs=({className:s,children:t,...a})=>e.jsx("div",{className:b("grid items-center",s),...a,children:e.jsx("span",{className:"text-xs font-bold tracking-wider uppercase",children:t})}),_=({className:s,children:t,...a})=>e.jsx("div",{className:b("grid items-center",s),...a,children:t}),Ws=({field:s,idx:t,formApi:a,remove:n})=>e.jsxs(u.Fragment,{children:[e.jsx(_,{children:e.jsx(as,{control:a.control,name:`runs.${t}.url`,placeholder:`https://ts-factory.io/logs/2022/11/14/fili-mcx5-${t+1}`,autoFocus:t===0})}),e.jsx(_,{children:e.jsx(ns,{name:`runs.${t}.range`,control:a.control,label:"Range",hideLabel:!0})}),e.jsx(_,{className:"grid place-items-center",children:t!==0?e.jsx(E,{content:"Delete row",children:e.jsx(p,{variant:"outline",onClick:()=>n(t),className:"grid rounded size-10 text-text-unexpected hover:bg-red-100 place-items-center",children:e.jsx(x,{name:"CrossSimple",size:24})})}):null})]},s.id);function Qs(s){const t=a=>{a||setTimeout(()=>s.onClose?.(),300)};return e.jsxs(ls,{onOpenChange:t,children:[e.jsx(is,{asChild:!0,children:e.jsxs(p,{variant:"outline",size:"md",rounded:"lg",children:[e.jsx(x,{name:"FilePlus",size:24,className:"mr-1.5 text-primary"}),e.jsx("span",{children:"Import"})]})}),e.jsx(os,{className:"min-w-[1000px]",children:e.jsxs(cs,{className:"bg-white max-h-[85vh] rounded-lg p-6",children:[e.jsx(E,{content:"Close",children:e.jsx(le,{asChild:!0,children:e.jsx(p,{variant:"ghost",className:"absolute top-4 right-4 p-1.5 hover:text-primary text-text-menu",children:e.jsx(x,{name:"Cross",size:14})})})}),e.jsx("div",{className:"flex-1 flex flex-col gap-4",children:s.children})]})})]})}function Ys({results:s,timestamp:t=new Date}){const{toggle:a}=Y();return e.jsxs("div",{children:[e.jsx(ye,{className:"text-lg font-semibold leading-none tracking-tight",children:"Import Runs"}),e.jsx(ds,{className:"mt-1.5 text-base text-gray-500",children:"Scheduled runs will be imported in the background"}),e.jsx("p",{className:"mt-1.5 mb-6 text-sm text-gray-500",children:"You can check the logs and flower tasks"}),e.jsx("h3",{className:"text-sm font-medium text-text-primary mb-2",children:"Imports"}),e.jsx("ul",{className:"border rounded-md [&>*:not(:last-child)]:border-b [&>*]:border-border-primary",children:s.map((n,r)=>{const i=n.url?new URL(n.url):null,c=i?i.origin+i.pathname:"";return e.jsxs("li",{className:"space-y-2 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx(Ie,{status:n.taskId?"SUCCESS":"FAILURE"}),e.jsx("span",{className:"text-xs text-gray-500",children:pe(new Date(t.getTime()-t.getTimezoneOffset()*6e4),"hh:mm a")})]}),c?e.jsx("a",{href:c,target:"_blank",className:"rounded-md bg-primary-wash p-2 text-sm font-mono block hover:underline",rel:"noreferrer",children:c}):null,e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(p,{variant:"outline-secondary",onClick:n.taskId?a(n.taskId,!0):void 0,className:"flex-1",children:[e.jsx(x,{name:"Paper",size:20,className:"mr-1.5"}),e.jsx("span",{children:"Log"})]}),e.jsx(p,{variant:"outline-secondary",className:"flex-1",asChild:!0,children:e.jsxs("a",{href:`${A.oldBaseUrl}/flower/task/${n.taskId}`,target:"_blank",rel:"noreferrer",children:[e.jsx(L,{className:"size-4 mr-1.5"}),e.jsx("span",{children:"Task"})]})})]})]},r)})})]})}const Ks=()=>{const[s]=ue(),[t,a]=u.useState("form"),[n,r]=u.useState([]),i=u.useRef(null);return{step:t,onFormClose:()=>{a("form"),r([])},onFormSubmit:async({runs:m})=>{const l=i.current?.form;if(l)try{const g=m.filter(f=>W.string().url().safeParse(f.url).success);if(!g.length){l.setError("root",{message:"You must enter at least one valid URL"});return}const h=await s(g).unwrap();a("result"),r(h)}catch(g){ms(g,{handle:l})}},celeryTasks:n,importFormRef:i}},Js=()=>{const{step:s,onFormClose:t,onFormSubmit:a,celeryTasks:n,importFormRef:r}=Ks(),{data:i,error:c,isLoading:d}=je.useGetAllProjectsQuery();return e.jsxs(Qs,{onClose:t,children:[s==="form"&&!c&&!d&&i&&e.jsx(Gs,{projects:i,onImportRunsSubmit:a,ref:r}),s==="result"&&e.jsx(Ys,{results:n})]})},nt=()=>(xs("Import - Bublik"),e.jsx("div",{className:"p-2 overflow-hidden h-full",children:e.jsx("div",{className:"flex flex-col gap-1 h-full",children:e.jsx(gs,{children:e.jsx(Bs,{children:e.jsx(Js,{})})})})}));export{nt as ImportPage};
//# sourceMappingURL=import-page-DubQULjC.js.map

{"version":3,"file":"index-DJ9zawUg.js","sources":["../../../bublik-ui/libs/bublik/features/history/src/lib/history-measurements-combined/history-measurements-combined.container.tsx"],"sourcesContent":["/* SPDX-License-Identifier: Apache-2.0 */\n/* SPDX-FileCopyrightText: 2021-2023 OKTET Labs Ltd. */\nimport { ComponentProps, useEffect, useMemo, useState } from 'react';\nimport { useSearchParams } from 'react-router-dom';\n\nimport { Point } from '@/shared/types';\nimport { createBublikError } from '@/services/bublik-api';\nimport { CardHeader, cn, Skeleton } from '@/shared/tailwind-ui';\nimport { StackedMeasurementChart } from '@/shared/charts';\nimport { LogPreviewContainer } from '@/bublik/features/log-preview-drawer';\n\nimport {\n\tuseCombinedView,\n\tuseGetHistoryMeasurements,\n\tuseGetHistoryMeasurementsByResult\n} from '../history-measurements/plot-list.hooks';\nimport { HistoryError } from '../history-error';\nimport { resolvePoint } from '../history-measurements/plot-list.utils';\n\nfunction HistoryMeasurementsCombinedContainer() {\n\tconst [searchParams] = useSearchParams();\n\tconst { data, isLoading, isFetching, error } = useGetHistoryMeasurements();\n\tconst {\n\t\tdata: byResult,\n\t\tisLoading: byResultLoading,\n\t\tisFetching: byResultFetching,\n\t\terror: byResultError\n\t} = useGetHistoryMeasurementsByResult();\n\tconst [point, setPoint] = useState<Point | null>(null);\n\tconst [isPointDialogOpen, setIsPointDialogOpen] = useState(false);\n\tconst { selectedGroup, selectedCharts, syncChartsFromData } =\n\t\tuseCombinedView();\n\n\tuseEffect(() => {\n\t\tif (!data || !byResult) return;\n\n\t\tconst allCharts = [\n\t\t\t...data,\n\t\t\t...byResult.flatMap((c) => c.measurement_series_charts)\n\t\t];\n\n\t\tsyncChartsFromData(allCharts);\n\t}, [data, byResult, syncChartsFromData]);\n\n\tconst plots = useMemo(() => {\n\t\tif (!data) return [];\n\t\tif (!byResult) return [];\n\n\t\tconst allCharts = [\n\t\t\t...data,\n\t\t\t...byResult.flatMap((c) => c.measurement_series_charts)\n\t\t];\n\n\t\tconst plotIdsStr = searchParams.get('combinedPlots');\n\n\t\tif (!plotIdsStr) return [];\n\n\t\tconst plotIds = plotIdsStr.split(';').map(String);\n\n\t\treturn allCharts\n\t\t\t.filter((p) => plotIds.includes(String(p.id)))\n\t\t\t.map((p) => ({\n\t\t\t\t...p,\n\t\t\t\tparameters: selectedCharts.find((c) => c.plot.id === p.id)?.parameters\n\t\t\t}));\n\t}, [byResult, data, searchParams, selectedCharts]);\n\n\tconst handleCombinedPointClick: ComponentProps<\n\t\ttypeof StackedMeasurementChart\n\t>['onPointClick'] = (config) => {\n\t\tconst plot = plots?.[config.componentIndex];\n\n\t\tif (!plot) return;\n\n\t\tconst point = resolvePoint(plot, config.dataIndex);\n\n\t\tif (!point) return;\n\n\t\tsetPoint(point);\n\t\tsetIsPointDialogOpen(true);\n\t};\n\n\tif (isLoading || byResultLoading) {\n\t\treturn <Skeleton className=\"h-screen rounded-sm\" />;\n\t}\n\n\tif (!plots.length) {\n\t\treturn (\n\t\t\t<HistoryError\n\t\t\t\terror={createBublikError({\n\t\t\t\t\ttitle: 'You have not selected plots',\n\t\t\t\t\tdescription: 'You need to select multiple plots to use this page',\n\t\t\t\t\tstatus: 400\n\t\t\t\t})}\n\t\t\t\twithoutStatus\n\t\t\t/>\n\t\t);\n\t}\n\n\tif (error || byResultError) {\n\t\treturn <HistoryError error={error || byResultError} />;\n\t}\n\n\treturn (\n\t\t<>\n\t\t\t{point && (\n\t\t\t\t<LogPreviewContainer\n\t\t\t\t\trunId={point?.run_id}\n\t\t\t\t\tresultId={point?.result_id}\n\t\t\t\t\tmeasurementId={point?.result_id}\n\t\t\t\t\topen={isPointDialogOpen}\n\t\t\t\t\tonOpenChange={setIsPointDialogOpen}\n\t\t\t\t/>\n\t\t\t)}\n\t\t\t<div className=\"bg-white rounded-md\">\n\t\t\t\t<CardHeader label=\"Combined\" />\n\t\t\t\t<div\n\t\t\t\t\tclassName={cn(\n\t\t\t\t\t\t'p-4 h-[78vh]',\n\t\t\t\t\t\t(isFetching || byResultFetching) && 'pointer-events-none opacity-60'\n\t\t\t\t\t)}\n\t\t\t\t>\n\t\t\t\t\t<StackedMeasurementChart\n\t\t\t\t\t\tcharts={plots}\n\t\t\t\t\t\tstyle={{ height: '100%' }}\n\t\t\t\t\t\tonPointClick={handleCombinedPointClick}\n\t\t\t\t\t\tenableResultErrorHighlight={selectedGroup === 'trend'}\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</>\n\t);\n}\n\nexport { HistoryMeasurementsCombinedContainer };\n"],"names":["HistoryMeasurementsCombinedContainer","searchParams","useSearchParams","data","isLoading","isFetching","error","useGetHistoryMeasurements","byResult","byResultLoading","byResultFetching","byResultError","useGetHistoryMeasurementsByResult","point","setPoint","useState","isPointDialogOpen","setIsPointDialogOpen","selectedGroup","selectedCharts","syncChartsFromData","useCombinedView","useEffect","allCharts","c","plots","useMemo","plotIdsStr","plotIds","p","handleCombinedPointClick","config","plot","resolvePoint","jsx","Skeleton","HistoryError","jsxs","Fragment","LogPreviewContainer","CardHeader","cn","StackedMeasurementChart","createBublikError"],"mappings":"kXAmBA,SAASA,GAAuC,CAC/C,KAAM,CAACC,CAAY,EAAIC,EAAA,EACjB,CAAE,KAAAC,EAAM,UAAAC,EAAW,WAAAC,EAAY,MAAAC,CAAA,EAAUC,EAAA,EACzC,CACL,KAAMC,EACN,UAAWC,EACX,WAAYC,EACZ,MAAOC,CAAA,EACJC,EAAA,EACE,CAACC,EAAOC,CAAQ,EAAIC,EAAAA,SAAuB,IAAI,EAC/C,CAACC,EAAmBC,CAAoB,EAAIF,EAAAA,SAAS,EAAK,EAC1D,CAAE,cAAAG,EAAe,eAAAC,EAAgB,mBAAAC,CAAA,EACtCC,EAAA,EAEDC,EAAAA,UAAU,IAAM,CACf,GAAI,CAACnB,GAAQ,CAACK,EAAU,OAExB,MAAMe,EAAY,CACjB,GAAGpB,EACH,GAAGK,EAAS,QAASgB,GAAMA,EAAE,yBAAyB,CAAA,EAGvDJ,EAAmBG,CAAS,CAC7B,EAAG,CAACpB,EAAMK,EAAUY,CAAkB,CAAC,EAEvC,MAAMK,EAAQC,EAAAA,QAAQ,IAAM,CAC3B,GAAI,CAACvB,EAAM,MAAO,CAAA,EAClB,GAAI,CAACK,EAAU,MAAO,CAAA,EAEtB,MAAMe,EAAY,CACjB,GAAGpB,EACH,GAAGK,EAAS,QAASgB,GAAMA,EAAE,yBAAyB,CAAA,EAGjDG,EAAa1B,EAAa,IAAI,eAAe,EAEnD,GAAI,CAAC0B,EAAY,MAAO,CAAA,EAExB,MAAMC,EAAUD,EAAW,MAAM,GAAG,EAAE,IAAI,MAAM,EAEhD,OAAOJ,EACL,OAAQM,GAAMD,EAAQ,SAAS,OAAOC,EAAE,EAAE,CAAC,CAAC,EAC5C,IAAKA,IAAO,CACZ,GAAGA,EACH,WAAYV,EAAe,KAAMK,GAAMA,EAAE,KAAK,KAAOK,EAAE,EAAE,GAAG,UAAA,EAC3D,CACJ,EAAG,CAACrB,EAAUL,EAAMF,EAAckB,CAAc,CAAC,EAE3CW,EAEeC,GAAW,CAC/B,MAAMC,EAAOP,IAAQM,EAAO,cAAc,EAE1C,GAAI,CAACC,EAAM,OAEX,MAAMnB,EAAQoB,EAAaD,EAAMD,EAAO,SAAS,EAE5ClB,IAELC,EAASD,CAAK,EACdI,EAAqB,EAAI,EAC1B,EAEA,OAAIb,GAAaK,EACTyB,EAAAA,IAACC,EAAA,CAAS,UAAU,qBAAA,CAAsB,EAG7CV,EAAM,OAaPnB,GAASK,EACLuB,EAAAA,IAACE,EAAA,CAAa,MAAO9B,GAASK,CAAA,CAAe,EAIpD0B,EAAAA,KAAAC,WAAA,CACE,SAAA,CAAAzB,GACAqB,EAAAA,IAACK,EAAA,CACA,MAAO1B,GAAO,OACd,SAAUA,GAAO,UACjB,cAAeA,GAAO,UACtB,KAAMG,EACN,aAAcC,CAAA,CAAA,EAGhBoB,EAAAA,KAAC,MAAA,CAAI,UAAU,sBACd,SAAA,CAAAH,EAAAA,IAACM,EAAA,CAAW,MAAM,UAAA,CAAW,EAC7BN,EAAAA,IAAC,MAAA,CACA,UAAWO,EACV,gBACCpC,GAAcK,IAAqB,gCAAA,EAGrC,SAAAwB,EAAAA,IAACQ,EAAA,CACA,OAAQjB,EACR,MAAO,CAAE,OAAQ,MAAA,EACjB,aAAcK,EACd,2BAA4BZ,IAAkB,OAAA,CAAA,CAC/C,CAAA,CACD,CAAA,CACD,CAAA,EACD,EA1CCgB,EAAAA,IAACE,EAAA,CACA,MAAOO,EAAkB,CACxB,MAAO,8BACP,YAAa,qDACb,OAAQ,GAAA,CACR,EACD,cAAa,EAAA,CAAA,CAsCjB"}
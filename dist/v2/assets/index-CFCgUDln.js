import{j as e}from"./shiki-CtY5KH0E.js";import{aL as T,aM as M,aN as B,aO as F,aP as $,aQ as w,s as W,aR as N,aS as f,aT as v,ab as K,ad as q,I as S,aJ as Q,i as O,o as I,aU as G,aV as U,aW as z,aX as _,aY as R,aZ as H,a_ as Z,a$ as J,b0 as V,A as X,p as Y,C as b}from"./index-rCMhFuXx.js";import{a as u}from"./react-BSMx3yqy.js";import"./reactJsonView-KCeSiE7A.js";import"./echarts-lseLLy92.js";import"./monaco-CdFZwoqU.js";import"./prettier-BE4rBlSX.js";function D(t,a){var r,s,o,n,c,l;T(1,arguments);var i=F(),x=M((r=(s=(o=(n=void 0)!==null&&n!==void 0?n:void 0)!==null&&o!==void 0?o:i.weekStartsOn)!==null&&s!==void 0?s:(c=i.locale)===null||c===void 0||(l=c.options)===null||l===void 0?void 0:l.weekStartsOn)!==null&&r!==void 0?r:0);if(!(x>=0&&x<=6))throw new RangeError("weekStartsOn must be between 0 and 6 inclusively");var m=B(t),d=m.getDay(),y=(d<x?7:0)+d-x;return m.setDate(m.getDate()-y),m.setHours(0,0,0,0),m}const E=()=>{const{query:t}=$(),a=w(t),r=a.data?{...t,page:"1",pageSize:String(a.data.pagination.count)}:W,s=w(r),o=u.useMemo(()=>{if(s.data)return s.data.results.map(({stats:n,start:c,conclusion:l,id:i})=>({runId:String(i),runStatus:l,total:n.tests_total,nok:n.tests_total_nok,nokPercent:n.tests_total_nok_percent,ok:n.tests_total_ok,okPercent:n.tests_total_ok_percent,planPercent:n.tests_total_plan_percent,passrate:Number((n.tests_total_ok/n.tests_total*100).toFixed(2)),date:new Date(c)}))},[s.data]);return{isLoading:a.isLoading||s.isLoading,isFetching:a.isFetching||s.isFetching,stats:o,queryData:s.data,error:a.error||s.error}},g=new Map([["ok","#65cd84"],["nok","#f95c78"],["total","#7283e2"]]),ee=t=>{const a=o=>(n,c)=>(n.value+=c[o],n),r=t.reduce(a("ok"),{name:"OK",value:0}),s=t.reduce(a("nok"),{name:"NOK",value:0});return[r,s]},te=t=>{const a=N(t,r=>r.runStatus);return Object.entries(a).map(([r,s])=>{const{label:o}=v(r);return{name:o.toUpperCase(),value:s.length}})},se=t=>{const a=N(t,r=>D(r.date).toISOString());return Object.entries(a).map(([r,s])=>{const o=s.reduce((l,i)=>l+i.nok,0),n=s.reduce((l,i)=>l+i.total,0),c=s.reduce((l,i)=>l+i.ok,0);return{date:new Date(r),total:n,ok:c,nok:o,passrate:Number((c/n*100).toFixed(2)),ids:s.map(l=>l.runId).join(",")}})},ae=(t,a)=>{const r=N(t,n=>D(n.date).toISOString()),s=Object.entries(r).reduce((n,[c,l])=>{const i=l.map(d=>d.runStatus),x=Array.from(new Set(i)),m={date:new Date(c),[f.Busy]:0,[f.Compromised]:0,[f.Error]:0,[f.Interrupted]:0,[f.Ok]:0,[f.Running]:0,[f.Stopped]:0,[f.Warning]:0,ids:l.map(d=>d.runId).join(",")};return x.forEach(d=>m[d]=i.filter(y=>y===d).length),Object.values(f).forEach(d=>{Object.keys(m).includes(d)||(m[d]=0)}),[...n,m]},[]),o=Object.values(f).filter(n=>s.some(c=>c[n]!==0));return{grouped:s,statuses:o}},P=({ids:t,open:a,onOpenChange:r})=>{const{queryData:s}=E();if(!s||!t.length)return null;const o=s.results.filter(n=>t.includes(String(n.id)));return e.jsx(K,{open:a,onOpenChange:r,children:e.jsxs(q,{className:"bg-white rounded-lg p-4 overflow-auto relative max-w-2xl",children:[e.jsx("button",{"aria-label":"Close modal",className:"rounded-md hover:bg-primary-wash p-1 absolute right-4 top-4 text-text-menu hover:text-primary",onClick:()=>r?.(!1),children:e.jsx(S,{name:"Cross",size:14})}),e.jsx("h2",{className:"text-2xl font-bold leading-tight tracking-tight text-text-primary mb-2.5",children:"Run List"}),e.jsx("ul",{className:"flex flex-col gap-4",children:o.map(n=>e.jsx("li",{children:e.jsx(re,{runId:String(n.id)})},n.id))})]})})},re=({runId:t})=>{const a=Q(t);if(a.error)return e.jsx("div",{children:"Something went wrong!"});if(a.isLoading)return e.jsx(O,{className:"rounded-md w-full h-16"});if(!a.data)return e.jsx("div",{children:"No data present!"});const{bg:r,color:s,icon:o}=v(a.data.conclusion);return e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:I("grid place-items-center rounded-l-md w-6",r,s),children:o}),e.jsxs("div",{className:"flex items-center justify-between flex-1 gap-4 py-1 pl-2 pr-4 border-r rounded-r-md border-y border-border-primary",children:[e.jsxs("div",{className:"flex flex-col justify-center",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"col-start-1 row-1 text-[0.6875rem] font-medium leading-[0.875rem] text-text-menu",children:"Name:"})," ",e.jsx("span",{className:"col-start-3 row-1 text-[0.6875rem] font-medium leading-[0.875rem]",children:a.data.main_package})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("span",{className:"col-start-1 row-1 text-[0.6875rem] font-medium leading-[0.875rem] text-text-menu",children:"Start:"})," ",e.jsx("span",{className:"col-start-3 row-1 text-[0.6875rem] font-medium leading-[0.875rem]",children:G(a.data.start)})]})]}),e.jsx("div",{children:e.jsx(U,{runId:Number(t)})})]})]})},ne=({stats:t})=>{const{grouped:a,statuses:r}=ae(t),s=te(t),o=u.useRef(null),n=u.useRef(null),[c,l]=u.useState(!1),[i,x]=u.useState([]),m=p=>{p||x([]),l(p)},d=u.useCallback(p=>{l(!0),x(t.filter(h=>h.runStatus===`run-${p.name.toLowerCase()}`).map(h=>h.runId))},[t]),y=u.useCallback(p=>{if(!p.seriesName)return;const{ids:h}=z.parse(p.data),k=h.split(","),A=`run-${p.seriesName.toLowerCase()}`,L=t.filter(j=>j.runStatus===A&&k.includes(j.runId)).map(j=>j.runId);l(!0),x(L)},[t]);return u.useEffect(()=>{o.current?.getEchartsInstance()?.on("click",d)},[d]),u.useEffect(()=>{n.current?.getEchartsInstance()?.on("click",y)},[y]),e.jsxs("section",{className:"flex items-center chart-mosaic",children:[e.jsx(P,{ids:i,open:c,onOpenChange:m}),e.jsx("div",{className:"w-1/2 px-4 py-2",children:e.jsx(_,{title:"Runs by conclusion",label:"Runs",dataset:{source:s},legend:{orient:"vertical",left:0,top:0},series:[{type:"pie",label:{formatter:"{b} ({d}%)"},itemStyle:{borderRadius:4,borderWidth:2,borderColor:"#fff",color:p=>v(`run-${p.name.toLowerCase()}`).bgRaw},encode:{value:"value",tooltip:"value",itemName:"name"}}],ref:o})}),e.jsx("div",{className:"w-1/2 px-4 py-2",children:e.jsx(R,{title:"Run conclusions by week",dataset:{source:a},legend:{},xAxis:{type:"time",name:"Date"},yAxis:{type:"value",name:"Runs"},series:r.map(p=>{const{label:h,bgRaw:k}=v(p);return{type:"bar",name:h.toUpperCase(),color:k,encode:{x:"date",y:p},stack:"run",emphasis:{focus:"series"}}}),ref:n})})]})},oe=({stats:t})=>{const a=u.useRef(null),[r,s]=u.useState(!1),[o,n]=u.useState([]),c=i=>{i||n([]),s(i)},l=i=>{const{ids:x}=H.parse(i.value),m=x.split(",");n(m),s(!0)};return u.useEffect(()=>{a.current?.getEchartsInstance()?.on("click",l)},[]),e.jsxs("section",{className:"flex items-center chart-mosaic",children:[e.jsx(P,{ids:o,open:r,onOpenChange:c}),e.jsx("div",{className:"w-1/2 px-4 py-2",children:e.jsx(_,{title:"Tests by result",label:"Results",dataset:{source:ee(t)},legend:{orient:"vertical",left:0,top:0},series:[{type:"pie",label:{formatter:"{b} ({d}%)"},itemStyle:{borderRadius:4,borderWidth:2,borderColor:"#fff",color:i=>g.get(i.name.toLowerCase())??"blue"},encode:{itemName:"name",value:"value",tooltip:"value"}}]})}),e.jsx("div",{className:"w-1/2 px-4 py-2",children:e.jsx(R,{title:"Tests by week",dataset:{source:se(t)},legend:{},xAxis:{type:"time",name:"Date"},yAxis:[{type:"value",name:"Results"},{id:"passrate",type:"value",name:"Pass rate"}],series:[{yAxisId:"passrate",type:"line",tooltip:{valueFormatter:i=>`${i}%`},name:"Pass rate",encode:{x:"date",y:"passrate"},emphasis:{focus:"series"}},{type:"bar",name:"OK",color:g.get("ok"),encode:{x:"date",y:"ok"},stack:"results",emphasis:{focus:"series"}},{type:"bar",name:"NOK",color:g.get("nok"),encode:{x:"date",y:"nok"},stack:"results",emphasis:{focus:"series"}}],ref:a})})]})};function C(){const t=J(),a=u.useRef(null);return u.useEffect(()=>{const r=a.current?.getEchartsInstance();r&&r.on("click",s=>{const o=V.safeParse(s.data);if(!o.success){X.error("Failed to parse run stat data");return}t({pathname:`/runs/${o.data.runId}`})})},[t]),{ref:a}}const ie=({stats:t})=>{const{ref:a}=C(),{ref:r}=C();return e.jsxs("section",{className:"",children:[e.jsx("div",{className:"px-4 py-2 border-b border-b-border-primary",children:e.jsx(R,{title:"Tests by day",dataset:{source:t},tooltip:{trigger:"axis"},legend:{},dataZoom:[{},{type:"inside"}],xAxis:{type:"time",name:"Date"},yAxis:[{type:"value",name:"Tests"},{id:"passrate",type:"value",name:"Pass rate"}],series:[{type:"bar",name:"OK",color:g.get("ok"),encode:{x:"date",y:"ok"},emphasis:{focus:"series"},stack:"stack"},{type:"bar",name:"NOK",color:g.get("nok"),encode:{x:"date",y:"nok"},emphasis:{focus:"series"},stack:"stack"},{yAxisId:"passrate",type:"line",name:"Pass Rate",encode:{x:"date",y:"passrate"},tooltip:{valueFormatter:s=>`${s}%`}}],ref:r})}),e.jsx("div",{className:"px-4 py-2",children:e.jsx(Z,{title:"Tests by day",dataset:{source:t},tooltip:{trigger:"axis"},legend:{},dataZoom:[{},{type:"inside"}],xAxis:{type:"time",name:"Date"},yAxis:[{type:"value",name:"Tests"},{id:"passrate",type:"value",name:"Pass rate"}],series:[{type:"line",name:"OK",color:g.get("ok"),encode:{x:"date",y:"ok"},emphasis:{focus:"series"}},{type:"line",name:"NOK",color:g.get("nok"),encode:{x:"date",y:"nok"},emphasis:{focus:"series"}},{yAxisId:"passrate",type:"line",name:"Pass Rate",encode:{x:"date",y:"passrate"},tooltip:{valueFormatter:s=>`${s}%`}}],ref:a})})]})},le=()=>e.jsxs("main",{className:"flex flex-col bg-white rounded-md",children:[e.jsx(b,{label:"Runs Stats"}),e.jsx(O,{className:"h-screen"})]}),ce=()=>e.jsx("div",{className:"grid place-items-center h-[calc(100vh-256px)]",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx(S,{name:"TriangleExclamationMark",size:24,className:"text-text-unexpected"}),e.jsx("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:"No results"}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:"No results found!"})]})}),de=t=>{const{error:a={}}=t,{title:r,description:s,status:o}=Y(a);return e.jsx("div",{className:"grid place-items-center h-[calc(100vh-256px)]",children:e.jsxs("div",{className:"flex flex-col items-center text-center",children:[e.jsx(S,{name:"TriangleExclamationMark",size:24,className:"text-text-unexpected"}),e.jsxs("h3",{className:"mt-2 text-sm font-medium text-gray-900",children:[o," ",r]}),e.jsx("p",{className:"mt-1 text-sm text-gray-500",children:s})]})})},ue=({stats:t})=>e.jsxs("main",{className:"flex flex-col gap-1",children:[e.jsxs("div",{className:"bg-white rounded-md",children:[e.jsx(b,{label:"Conclusion Stats"}),e.jsx(ne,{stats:t})]}),e.jsxs("div",{className:"bg-white rounded-md",children:[e.jsx(b,{label:"Tests Stats"}),e.jsx(oe,{stats:t})]}),e.jsxs("div",{className:"bg-white rounded-md",children:[e.jsx(b,{label:"Day Stats"}),e.jsx(ie,{stats:t})]})]}),je=()=>{const{stats:t,isLoading:a,error:r,isFetching:s}=E();return r?e.jsx(de,{error:r}):a?e.jsx(le,{}):!t||!t.length?e.jsx(ce,{}):e.jsx("div",{className:I(s&&"opacity-40 pointer-events-none"),children:e.jsx(ue,{stats:t})})};export{je as RunsStatsContainer};
//# sourceMappingURL=index-CFCgUDln.js.map
